{% if site.organisations.size > 0 %}
<!-- Sponsors Section -->
<section id="portfolio">
    <div class="container">
        {% assign sponsors = site.organisations | where: "is_sponsor", true | where: "jurisdiction", include.jurisdiction_gid %}
        
        {% comment %}
        =======================================
        Filter out local event sponsors from the state sponsors.
        =======================================
        {% endcomment %}

        {% assign sponsor_cat = include.sponsor_level %}
        {% if include.sponsor_level == "state" %}
            {% assign sponsors = sponsors | where: "events", "" %}
        {% elsif include.sponsor_level == "local" %}
            {% assign sponsor_cat = "state" %}
        {% endif %}

        {% if sponsors.size > 0 %}
            <!-- {{ include.jurisdiction_name }} Sponsors -->
            <div class="row header-row">
            <div class="col-lg-12 text-center">
                <h2 class="section-heading" data-toc-text="{{ include.jurisdiction_name }} Sponsors">{{ include.jurisdiction_name }} Sponsors</h2>
            </div>
            </div>
            <div class="row">
            {% assign sponsors_by_level = sponsors | group_by: "sponsor_level_id" %}

                <div class="container-fluid govhack-sponsors">
                {% for sponsor_level in site.data.sponsor_config[sponsor_cat].classes %}
                    {% assign col_width = 12 | divided_by: sponsor_level.columns | round: 0 %}

                    {% for sponsor_cat in sponsors_by_level %}
                        {% if sponsor_cat.name == sponsor_level.slug %}
                            {% if include.sponsor_level == "local" %}
                                {% assign local_sponsors = false %}
                                {% for sponsor in sponsor_cat.items %}
                                    {% if sponsor.events contains include.location_gid %}
                                        {% assign local_sponsors = true %}
                                        {% break %}
                                    {% endif %}
                                {% endfor %}

                                {% if local_sponsors == false %}
                                    {% continue %}
                                {% endif %}
                            {% endif %}

                            <h3>{{ sponsor_cat.items[0].sponsor_level_desc }}</h3>

                            {% assign sponsor_num = 0 %}

                            {% comment %}
                            =======================================
                            This horrendous hack brought to you by the state of modern web development.
                            http://stackoverflow.com/a/20548578

                            No, seriously.

                            If you're changing this code PLEASE make sure you change the readable version
                            inside this comment, and the actual version that's used for rendering.
                            =======================================
                            {% for sponsor in sponsor_cat.items %}
                                {% if include.sponsor_level == "local" %}
                                    {% unless sponsor.events contains include.location_gid %}
                                        {% continue %}
                                    {% endunless %}
                                {% endif %}

                                {% assign modulo = sponsor_num | modulo: sponsor_level.columns %}
                                {% if modulo == 0 %}
                                    {% if sponsor_num > 0 %}
                                        </div>
                                    {% endif %}
                                    <div class="row">
                                {% endif %}

                                <div class="col-md-{{ col_width }} vcenter text-center">
                                    <a href="{{ sponsor.url }}"><img src="{{ sponsor.logo_url }}"></a>
                                </div>

                                {% assign sponsor_num = sponsor_num | plus: 1 %}
                            {% endfor %}
                            <!-- Closes the trailing <div class="row"> -->
                            </div>
                            {% endcomment %}

                            
                            {% comment %}
                            =======================================
                            This is the ACTUAL code for rendering sponsor logos into rows and columns.
                            =======================================
                            {% endcomment %}

                            {% for sponsor in sponsor_cat.items %}{% if include.sponsor_level == "local" %}{% unless sponsor.events contains include.location_gid %}{% continue %}{% endunless %}{% endif %}{% assign modulo = sponsor_num | modulo: sponsor_level.columns %}{% if modulo == 0 %}{% if sponsor_num > 0 %}</div>{% endif %}<div class="row">{% endif %}<div class="col-sm-12 col-md-{{ col_width }} vcenter text-center"><a href="{{ sponsor.url }}"><img src="{{ sponsor.logo_url }}"></a></div>{% assign sponsor_num = sponsor_num | plus: 1 %}{% endfor %}<!-- Closes the trailing <div class="row"> --></div>

                            {% break %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</section>
{% endif %}